<html>
<head>
  <!-- Latest compiled and minified CSS & JS -->
  <link rel="stylesheet" media="screen" href="//netdna.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
</head>
<body>
  
  <div class="container text-center" style="margin-top: 3em;">
    <div id="alert-div"></div>
    <div class="row">
    <h3>Find Transports which matches the following criteria:</h3>
    <hr/>
    <label>
      Within a radius of <input type="text" class="form-control input-sm" id="radius" value="7" />&nbsp;
      <select class="form-control input-sm" id="unit">
        <option selected>km</option>
        <option>m</option>
        <option>ft</option>
        <option>mi</option>
      </select>&nbsp;
      from 
      Latitude <input type="text" class="form-control input-sm" id="lat" value="22.5726" />&nbsp;&amp;&nbsp;
      Longitude <input type="text" class="form-control input-sm" id="lng" value="88.3639" />
    </label>
    <br/>
    <br/>
    <button type="button" class="disable-while-talking btn btn-large btn-info" onclick="fetchData(renderTemplate);">FIND</button>
    <br/>
    <br/>
    <hr/>
    <br/>
    <br/>
    <!-- Radius: <input type="text" id="us3-radius"/> -->
    </div>
    <div class="row">
      
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Driver ID</th>
            <th>Location 
            <span class="badge badge-info">LIVE!</span>
            </th>
          </tr>
        </thead>
        <tbody id="target">
        </tbody>
      </table>
      
    </div>

  </div>

  <script id="template" type="x-tmpl-mustache">
    {{#drivers}}
    <tr>
      <td> {{id}} </td>}
      <td data-driver-id="{{id}}">Lat: {{lat}}; Lng: {{lng}}</td>
    </tr>
    {{/drivers}}
  </script>

  <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
  <script src="https://cdn.rawgit.com/janl/mustache.js/b283da5c/mustache.js"></script>
  <script src="//netdna.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
  <script type="text/javascript" src='http://maps.google.com/maps/api/js? sensor=false&libraries=places&key=AIzaSyBfXwliPdMdFFkPNRGQByETe4sn-x06X_4'></script>
  <script src="https://cdn.rawgit.com/Logicify/jquery-locationpicker-plugin/fac86581/dist/locationpicker.jquery.min.js"></script>
  <script type="text/javascript" src="http://localhost:3000/faye/client.js">
  </script>
  <script>
    var faye = new Faye.Client('http://localhost:3000/faye');
    var subscription, promptInterval;

    var template = $('#template').html();
    Mustache.parse(template);   // optional, speeds up future uses

    function promptRefresh() {
      $("#alert-div").html("")
      try {
        clearInterval(promptInterval)
      } catch (e) {
        console.log("NON-FATAL WARNING: Unable to cancel promptInterval");
      } finally {
        promptInterval = setInterval(function () {
          $("#alert-div").html(`<div class="alert alert-warning alert-dismissable">
            <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
            <strong>WARNING: </strong>Data might be out of date!
            <button type="button" class="btn btn-xs btn-success pull-right clearfix" onclick="fetchData(renderTemplate);">Refresh Now</button>
</div>`);
        }, 1 * 60 * 1000) // 1 minute interval
      }
    }

    function fetchData(cb) {
      $(".disable-while-talking").prop("disabled", true)
      var lat = $("#lat").val()
      var lng = $("#lng").val()
      var radius = $("#radius").val()
      var unit = $("#unit").val()
      $.ajax({
        method: "GET",
        dataType: "json",
        url: `http://localhost:3000/near?lat=${lat}&lng=${lng}&radius=${radius}&unit=${unit}`,
        success: function (data) {
          console.log(data);
          try {
            subscription.cancel()
          } catch (e) {
            console.log("NON-FATAL WARNING: Unable to cancel exisiting subscriptions");
          } finally {
            subscription = faye
            .subscribe("/location/*")
            .withChannel((channel, message) => {
              console.log("msg rcvd: ", channel, message);
              $(`td[data-driver-id='${message.id}']`).html(`Lat: ${message.lat}; Lng: ${message.lng}`)
            })
          }
          promptRefresh()
          $(".disable-while-talking").prop("disabled", false)
          cb(data)
        },
        error: function () {
          console.log("OOOOPPPPPSSSS..........Network error!");
          $(".disable-while-talking").prop("disabled", false)
        }
      })
    }

    function renderTemplate(data) {
      var rendered = Mustache.render(template, { drivers: data });
      $("#target").html(rendered)
    }

     // at load / dom ready.......
     fetchData(renderTemplate);
  </script>
</body>
</html>